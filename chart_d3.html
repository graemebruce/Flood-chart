
<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">

<style type="text/css">
  /*css to go here*/
  body {
        font-family: "Open Sans",sans-serif;
    font-size: 12px;
  }
  .g-hed {
    text-align: center;
    font-weight: bold;
    font-size:22px; 
    margin: 3px 0;
  }

  .Todayslevels span {
    color: "#fffff";
  }




  .year  {
   fill:none;
    stroke: red;
    stroke-width: 2px;
    stroke-opacity:0.6;
    shape-rendering: geometricPrecision;


  }

  #year-2017 {
stroke-opacity:1;
    stroke: #0078A9;
    stroke-width: 6px;
  }

  #year-2011 {

    stroke: #ffbc42;
  }

   #year-2009 {

    stroke: #d81159;
  }

  #year-1997 {

    stroke: #8f2d56;
  }

   #year-1950 {

    stroke: #73d2de;
  }

 


  
  .g-source {
   padding: .5em 1em;
    text-align: left;
    background: #eee;
    font-size: .8em;
  }
  .g-source-bold {
    text-align: left;
    font-size:10px; 
  }
  .g-intro {

    font-weight: 400;
    font-size: .9em;
    color: #777;
    margin-top: 2em;
    text-align: center;
    fill : #777;
  }
  .g-labels {

    fill: white;
    font-weight: bold;
    font-size: 14px;
  }
  .axis line {
    fill: none;
    stroke: #eee;
    stroke: 2px solid #eee;
    shape-rendering: crispEdges;
    stroke-width: 0px;
  }
  .axis text {
    font-size: .9em;
    pointer-events: none;
    fill: #555;
  }
  .y.axis text {
    text-anchor: end !important;
    font-size:.9em;
    fill: #555;
  }
  .domain {
    display: none;
  }


  .line {
    stroke-width: 1.5px;
    fill: none;

  }
  .overlay {
    fill: none;
    pointer-events: all;
  }
  .focus {
    font-size: 14px;
  }
  .focus circle {
    fill: #5e8dc9;
  }

 #legend {
list-style-type: none;



  }

  #legend li {
display: inline-block;
text-align: center;
padding:5px;


  }

   #legend-1950  {
border: 3px solid #73d2de;
  }

  #legend-1997  {
border: 3px solid #8f2d56;
  }

  #legend-2009  {
border: 3px solid #d81159;
  }


#legend-2011  {
border: 3px solid #ffbc42;
  }

  #legend-2017  {
border: 3px solid #0078A9;
  }





  
</style>

<body>
  <h5 class="g-hed">The water is <span class="Todayslevels" style="color:#0078A9"></span> feet above James Avenue datum</h5>
  
  <p class="g-intro"></p>
  <ul id="legend">
  <li id = "legend-1950">1950</li>
  <li id = "legend-1997">1997</li>
  <li id = "legend-2009">2009</li>
  <li id = "legend-2011">2011</li>
  <li id = "legend-2017">2017</li>




  </ul>


  <div class="g-chart"></div>
    <div class="g-source"><span class="g-source-bold"></span><span class="g-source-reg"></span></div>
  </div>
</body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js" charset="utf-8"></script>

<script>
//Margin conventions
var margin = {top: 20, right: 70, bottom: 40, left: 50};
var widther = window.outerWidth;
var width = widther - margin.left - margin.right,
    height = 400 - margin.top - margin.bottom;
//Parses date for correct time format
var parseDate = d3.time.format("%d/%m").parse;
//Divides date for tooltip placement
var bisectDate = d3.bisector(function(d) { return d.day; }).left;    
//Appends the svg to the chart-container div
var svg = d3.select(".g-chart").append("svg")
  .attr("width", width + margin.left + margin.right)
  .attr("height", height + margin.top + margin.bottom)
  .append("g")
  .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
//Creates the xScale 
var xScale = d3.time.scale()
  .range([0, width]);
//Creates the yScale
var yScale = d3.scale.linear()
  .range([height, 0]);
//Defines the y axis styles
var yAxis = d3.svg.axis()
  .scale(yScale)
  .tickSize(-width)
  .tickPadding(8)
  .orient("left");
//Defines the y axis styles
var xAxis = d3.svg.axis()
  .scale(xScale)
  .tickPadding(8)
  .orient("bottom")
  .tickSize(height)
  .ticks(numTicks(width))
  .tickFormat(d3.time.format("%d %b")); 
//line function convention (feeds an array)
var line = d3.svg.line()
  .x(function(d) { return xScale(d.day); })
  .y(function(d) { return yScale(d.level); });


     


var area = d3.svg.area()
    .x(function(d) { return x(d.day); })
    .y0(height)
    .y1(function(d) { return y(d.close); }); 



//Loads the data
d3.csv("water_levels.csv", ready);
function ready(err, data) {

  //FORMAT data
  data.forEach(function(d) {
    d.level = +d.level;
    d.day = parseDate(d.day);


  });

 
  
  //Appends latest value

  //??
d3.select(".Todayslevels").text("9.5");


  //Appends chart headline
  // d3.select(".g-hed").text("Flood levels");
  //Appends chart intro text
  d3.select(".g-intro").text("HEY! 2017 numbers are in here by hand. This is where it will say when the widget's been updated. Also, that 9.5 up there isn't dynamic because reasons. And it's not right. Or at least if it is, it's by accident.");
  data.sort(function(a,b) { return a.day - b.day; });
  //Defines the xScale max
  xScale.domain(d3.extent(data, function(d) { return d.day; }));
  //Defines the yScale max
  yScale.domain(d3.extent(data, function(d) { return d.level; }));

   // Nest the entries by year
    var dataNest = d3.nest()
        .key(function(d) {return d.year;})
        .entries(data);

    var color = d3.scale.category10();

    // Loop through each year / key
 dataNest.forEach(function(d) {


    svg.append("path")
        .attr("class", function() {
            var thisClassList = "year";
            return thisClassList;
         })
        .attr("id", function() {
            var thisID = "year-" + d.key;
            return thisID;
         })
      .attr("d", line(d.values));

});







  //Appends the y axis
  var yAxisGroup = svg.append("g")
    .attr("class", "y axis")
    .call(yAxis);
  //Appends the x axis    
  var xAxisGroup = svg.append("g")
    .attr("class", "x axis")
    .call(xAxis);
  //Binds the data to the line
  var drawline = svg.append("path")
    .datum(data)
    .attr("class", "line")
    .attr("d", line);     



  //Tooltips
  var focus = svg.append("g")
      .attr("class", "focus")
      .style("display", "none");
  //Adds circle to focus point on line
  focus.append("circle")
      .attr("r", 4);
  //Adds text to focus point on line    
  focus.append("text")
      .attr("x", 9)
      .attr("dy", ".35em");  

// axis labels
  svg.append("text")
            .attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
            .attr("class", "g-intro")
            .attr("transform", "translate("+ (-margin.left/2 - 5) +","+(height/2)+")rotate(-90)")  // text is drawn off the screen top left, move down and out and rotate
            .text("feet");












  
 /* //Creates larger area for tooltip   
  var overlay = svg.append("rect")
      .attr("class", "overlay")
      .attr("width", width)
      .attr("height", height)
      .on("mouseover", function() { focus.style("display", null); })
      .on("mouseout", function() { focus.style("display", "none"); })
      .on("mousemove", mousemove);
  
  //Tooltip mouseovers            
  function mousemove() {
    var x0 = xScale.invert(d3.mouse(this)[0]),
        i = bisectDate(data, x0, 1),
        d0 = data[i - 5],
        d1 = data[i],
        d = x0 - d0.day > d1.day - x0 ? d1 : d0;
    focus.attr("transform", "translate(" + xScale(d.day) + "," + yScale(d.level) + ")");
    focus.select("text").text(d.level);
  }; 

  
  */
  //Appends chart source
  d3.select(".g-source-reg")
    .text("Live data source: Water Survey of Canada/Environment Canada via the City of Winnipeg")
    .attr("class", "g-source-reg"); 
      
 //RESPONSIVENESS
 // d3.select(window).on("resize", resized);
  function resized() {
    //new margin
    var newMargin = {top: 10, right: 80, bottom: 20, left: 50};
    //Get the width of the window
    var w = d3.select(".g-chart").node().clientWidth;
    console.log("resized", w);
    //Change the width of the svg
    d3.select("svg")
      .attr("width", w);
    //Change the xScale
    xScale
      .range([0, w - newMargin.right]);
    //Update the line
    line = d3.svg.line()
      .x(function(d) { return xScale(d.day); })
      .y(function(d) { return yScale(d.level); }); 
    d3.selectAll('.line')
      .attr("d", line);  
    //Updates xAxis
    xAxisGroup
      .call(xAxis);   
    //Updates ticks
    xAxis
      .scale(xScale)
      .ticks(numTicks(w));
    //Updates yAxis  
    yAxis
      .tickSize(-w - newMargin.right)
  };
}
//Determines number of ticks base on width
function numTicks(widther) {
  if (widther <= 900) {
    return 4
    console.log("return 4")
  }
  else {
    return 12
    console.log("return 5")
  }
}

</script>
